<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Monitor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .pulse-animation::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans min-h-screen flex items-center justify-center">

    <div class="w-full max-w-md p-8 text-center">
        
        <!-- Status Display -->
        <div id="statusDisplay" class="space-y-6">
            
            <!-- Icon -->
            <div class="relative w-32 h-32 mx-auto">
                <div id="pulseRing" class="absolute inset-0 rounded-full opacity-0"></div>
                <div class="w-full h-full bg-gradient-to-br from-blue-600 to-indigo-700 rounded-full flex items-center justify-center">
                    <i id="statusIcon" class="fa-solid fa-spinner fa-spin text-4xl text-white"></i>
                </div>
            </div>

            <!-- Status Text -->
            <div>
                <h1 id="statusTitle" class="text-2xl font-bold text-white mb-2">Menginisialisasi...</h1>
                <p id="statusDesc" class="text-slate-400 text-sm">Mohon tunggu</p>
            </div>

            <!-- Device Info -->
            <div id="deviceInfo" class="bg-slate-900 rounded-xl p-4 text-xs font-mono text-slate-500 hidden">
                <div>Device: <span id="deviceType" class="text-slate-300">-</span></div>
                <div>Status: <span id="deviceStatus" class="text-slate-300">-</span></div>
                <div>User: <span id="userEmail" class="text-slate-300">-</span></div>
            </div>

            <!-- Mobile Mic Button (hidden by default) -->
            <button id="mobileMicBtn" onclick="toggleMic()" class="hidden w-full py-6 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition-all active:scale-95 bg-slate-800 text-slate-400 border border-slate-700">
                <i class="fa-solid fa-microphone-slash"></i>
                <span>TEKAN UNTUK BICARA</span>
            </button>

        </div>

    </div>

    <audio id="remoteAudio" autoplay playsinline class="hidden"></audio>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, addDoc, serverTimestamp, query, where, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDbhegMTo3-AG4tUPQJkbwlXMbUZmdjVTk",
            authDomain: "p2paudio-fdbde.firebaseapp.com",
            projectId: "p2paudio-fdbde",
            storageBucket: "p2paudio-fdbde.firebasestorage.app",
            messagingSenderId: "734885014321",
            appId: "1:734885014321:web:e6fef64fb7d58802cc9e10",
            measurementId: "G-GTQW9KLKE4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Set persistence
        setPersistence(auth, browserLocalPersistence);

        // Global Variables
        let currentUser = null;
        let deviceId = getDeviceId();
        let deviceType = detectDeviceType();
        let roomId = null;
        let peerConnection = null;
        let localStream = null;
        let isMuted = false;

        // HTML Elements
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusDesc = document.getElementById('statusDesc');
        const pulseRing = document.getElementById('pulseRing');
        const deviceInfo = document.getElementById('deviceInfo');
        const mobileMicBtn = document.getElementById('mobileMicBtn');

        // STUN Servers
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // Detect device type automatically
        function detectDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            const isMobile = /mobile|android|iphone|ipad|ipod/.test(ua);
            return isMobile ? 'mobile' : 'laptop';
        }

        // Generate/Get device ID
        function getDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = 'device_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }

        // Update UI status
        function updateStatus(icon, title, desc, showPulse = false) {
            statusIcon.className = `fa-solid ${icon} text-4xl text-white`;
            statusTitle.textContent = title;
            statusDesc.textContent = desc;
            
            if (showPulse) {
                pulseRing.className = 'absolute inset-0 rounded-full pulse-animation text-emerald-500/20';
            } else {
                pulseRing.className = 'absolute inset-0 rounded-full opacity-0';
            }
        }

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Update device info
                document.getElementById('deviceType').textContent = deviceType.toUpperCase();
                document.getElementById('userEmail').textContent = user.email;
                deviceInfo.classList.remove('hidden');
                
                // Auto start
                await autoStart();
            } else {
                // No user - try to login
                updateStatus('fa-right-to-bracket', 'Login Diperlukan', 'Membuka jendela login...');
                setTimeout(async () => {
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        updateStatus('fa-exclamation-triangle', 'Login Gagal', 'Silakan refresh halaman');
                    }
                }, 1000);
            }
        });

        // Auto Start
        async function autoStart() {
            try {
                if (deviceType === 'laptop') {
                    await startLaptop();
                } else {
                    await startMobile();
                }
            } catch (err) {
                updateStatus('fa-exclamation-triangle', 'Error', err.message);
            }
        }

        // Start Laptop (Host)
        async function startLaptop() {
            updateStatus('fa-laptop', 'Laptop Mode', 'Mengaktifkan mikrofon...');
            document.getElementById('deviceStatus').textContent = 'LAPTOP (HOST)';
            
            roomId = 'room_' + currentUser.uid;

            try {
                // Register device
                await setDoc(doc(db, `users/${currentUser.uid}/devices/${deviceId}`), {
                    type: 'laptop',
                    online: true,
                    roomId: roomId,
                    lastSeen: serverTimestamp()
                });

                // Get mic - laptop always ON
                await setupLocalAudio(false);
                
                updateStatus('fa-microphone', 'Mic Aktif', 'Menunggu perangkat lain...');
                
                createPeerConnection();

                // WebRTC Offer
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        addDoc(collection(db, `calls/${roomId}/callerCandidates`), event.candidate.toJSON());
                    }
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await setDoc(doc(db, `calls/${roomId}`), {
                    offer: { type: offer.type, sdp: offer.sdp },
                    createdAt: serverTimestamp()
                });

                // Listen for answer
                onSnapshot(doc(db, `calls/${roomId}`), (snapshot) => {
                    const data = snapshot.data();
                    if (!peerConnection.currentRemoteDescription && data?.answer) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });

                // Listen for callee candidates
                onSnapshot(collection(db, `calls/${roomId}/calleeCandidates`), (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        }
                    });
                });

            } catch (err) {
                updateStatus('fa-exclamation-triangle', 'Error', err.message);
            }
        }

        // Start Mobile (Client)
        async function startMobile() {
            updateStatus('fa-mobile-screen', 'HP Mode', 'Mencari laptop...');
            document.getElementById('deviceStatus').textContent = 'HP (REMOTE)';

            try {
                // Register device
                await setDoc(doc(db, `users/${currentUser.uid}/devices/${deviceId}`), {
                    type: 'mobile',
                    online: true,
                    lastSeen: serverTimestamp()
                });

                // Find laptop
                const devicesRef = collection(db, `users/${currentUser.uid}/devices`);
                const q = query(devicesRef, where('type', '==', 'laptop'), where('online', '==', true));
                
                const checkLaptop = async () => {
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        const laptopData = snapshot.docs[0].data();
                        roomId = laptopData.roomId;
                        await connectToRoom();
                        return true;
                    }
                    return false;
                };

                // Check immediately
                if (await checkLaptop()) return;

                // Listen for laptop coming online
                updateStatus('fa-mobile-screen', 'Menunggu Laptop', 'Laptop belum online...');
                onSnapshot(q, async (snapshot) => {
                    if (!snapshot.empty && !roomId) {
                        const laptopData = snapshot.docs[0].data();
                        roomId = laptopData.roomId;
                        await connectToRoom();
                    }
                });

            } catch (err) {
                updateStatus('fa-exclamation-triangle', 'Error', err.message);
            }
        }

        // Connect to Room (Mobile)
        async function connectToRoom() {
            try {
                updateStatus('fa-link', 'Menyambung...', 'Menghubungi laptop...');

                const callDoc = doc(db, `calls/${roomId}`);
                const snapshot = await getDoc(callDoc);

                if (!snapshot.exists()) {
                    updateStatus('fa-exclamation-triangle', 'Room Tidak Ditemukan', 'Laptop belum siap');
                    return;
                }

                // Mobile mic OFF by default
                await setupLocalAudio(true);
                createPeerConnection();

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        addDoc(collection(db, `calls/${roomId}/calleeCandidates`), event.candidate.toJSON());
                    }
                };

                const offerData = snapshot.data().offer;
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData));

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await updateDoc(callDoc, {
                    answer: { type: answer.type, sdp: answer.sdp }
                });

                updateStatus('fa-headphones', 'Mendengarkan...', 'Terhubung dengan laptop');

                // Show mic button for talk-back
                mobileMicBtn.classList.remove('hidden');

                // Listen for caller candidates
                onSnapshot(collection(db, `calls/${roomId}/callerCandidates`), (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        }
                    });
                });

            } catch (err) {
                updateStatus('fa-exclamation-triangle', 'Error Connect', err.message);
            }
        }

        // Setup Local Audio
        async function setupLocalAudio(muted = false) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: false
                });

                localStream.getAudioTracks()[0].enabled = !muted;
                isMuted = muted;

                if (deviceType === 'mobile') {
                    updateMicUI();
                }
            } catch (err) {
                throw new Error('Gagal akses mikrofon: ' + err.message);
            }
        }

        // Create Peer Connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            peerConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;

                if (state === 'connected') {
                    if (deviceType === 'laptop') {
                        updateStatus('fa-broadcast-tower', 'Streaming...', 'HP terhubung - Suara terkirim', true);
                    } else {
                        updateStatus('fa-headphones', 'Mendengarkan...', 'Audio dari laptop diterima', true);
                    }
                } else if (state === 'disconnected' || state === 'failed') {
                    if (deviceType === 'laptop') {
                        updateStatus('fa-microphone', 'Mic Aktif', 'Menunggu perangkat lain...');
                    } else {
                        updateStatus('fa-mobile-screen', 'Terputus', 'Koneksi dengan laptop terputus');
                    }
                }
            };
        }

        // Toggle Mic (Mobile only)
        window.toggleMic = () => {
            if (deviceType !== 'mobile' || !localStream) return;

            const track = localStream.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                isMuted = !track.enabled;
                updateMicUI();
            }
        };

        // Update Mic UI (Mobile)
        function updateMicUI() {
            if (deviceType === 'mobile') {
                if (isMuted) {
                    mobileMicBtn.className = 'w-full py-6 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition-all active:scale-95 bg-slate-800 text-slate-400 border border-slate-700';
                    mobileMicBtn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i><span>TEKAN UNTUK BICARA</span>';
                } else {
                    mobileMicBtn.className = 'w-full py-6 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition-all active:scale-95 bg-emerald-600 text-white shadow-lg shadow-emerald-500/20';
                    mobileMicBtn.innerHTML = '<i class="fa-solid fa-microphone animate-bounce"></i><span>SEDANG BICARA...</span>';
                }
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', async () => {
            if (deviceId && currentUser) {
                await updateDoc(doc(db, `users/${currentUser.uid}/devices/${deviceId}`), {
                    online: false
                });
            }
        });

        // Auto-reconnect on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentUser) {
                // Page visible again - check connection
                if (peerConnection && peerConnection.connectionState === 'disconnected') {
                    location.reload();
                }
            }
        });

    </script>
</body>
</html>
