<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google</title> 
    <link rel="icon" href="https://www.google.com/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .pulse-animation::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        .hidden { display: none !important; }
        .google-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #ffffff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }
        /* Style khusus untuk indikator sinyal */
        .signal-bars { display: inline-flex; gap: 2px; align-items: flex-end; height: 12px; }
        .bar { width: 3px; background-color: #475569; border-radius: 1px; }
        .bar.active { background-color: #10b981; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans min-h-screen flex flex-col">

    <div id="mainAppContainer" class="flex flex-col min-h-screen transition-opacity duration-500">
        <!-- HEADER -->
        <header class="p-4 border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-10 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-user-secret text-indigo-400"></i>
                <h1 class="font-bold text-lg tracking-tight">AudioBridge <span class="text-[10px] font-normal text-white bg-indigo-600 px-1.5 py-0.5 rounded ml-1">TCP/443</span></h1>
            </div>
            <div id="connectionStatus" class="flex items-center gap-2 text-xs font-mono bg-slate-800 px-3 py-1.5 rounded-full text-slate-400 border border-slate-700">
                <div class="w-2 h-2 rounded-full bg-slate-500" id="statusDot"></div>
                <span id="statusText">OFFLINE</span>
            </div>
        </header>

        <main class="flex-1 flex flex-col items-center justify-center p-6 w-full max-w-md mx-auto relative">
            
            <!-- LANDING PAGE -->
            <div id="landingPage" class="w-full space-y-8 transition-all duration-300">
                <div class="text-center space-y-2">
                    <h2 class="text-2xl font-bold text-white">Stealth Mode</h2>
                    <p class="text-slate-400 text-sm">Lewat Jalur HTTPS (Port 443) Anti-Blokir</p>
                </div>

                <!-- HOST BUTTON -->
                <button onclick="startHosting()" class="w-full group relative overflow-hidden rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-700 p-6 text-left hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-indigo-900/20 border border-indigo-500/30">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-server text-6xl text-white"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-lg font-bold text-white mb-1">Laptop / Host</h3>
                        <p class="text-indigo-100 text-xs">Buat jaringan aman & ID Sesi</p>
                        <div class="mt-4 flex items-center gap-2 text-[10px] text-indigo-200 bg-black/20 w-fit px-2 py-1 rounded">
                            <i class="fa-solid fa-shield-halved"></i> <span>Enkripsi TCP Aktif</span>
                        </div>
                    </div>
                </button>

                <!-- DIVIDER -->
                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-slate-800"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-600 text-[10px] uppercase tracking-widest">Akses Perangkat Lain</span>
                    <div class="flex-grow border-t border-slate-800"></div>
                </div>

                <!-- JOIN FORM -->
                <div class="bg-slate-900/50 backdrop-blur p-1 rounded-2xl border border-slate-800">
                    <div class="bg-slate-950 rounded-xl p-4 space-y-3">
                        <label class="text-xs text-slate-400 font-medium ml-1">ID SESI HOST:</label>
                        <div class="flex gap-2">
                            <input type="text" id="joinInput" placeholder="A1B2C3" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-center text-lg font-mono tracking-widest text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 uppercase transition-all placeholder:text-slate-700">
                            <button onclick="joinRoom()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/20">
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTIVE CALL PAGE -->
            <div id="activePage" class="hidden w-full space-y-6 text-center transform transition-all duration-500">
                
                <!-- Status Card -->
                <div id="statusCard" class="relative p-8 rounded-3xl bg-slate-900 border border-slate-800 overflow-hidden shadow-2xl">
                    <div id="rippleEffect" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                        <div class="w-40 h-40 rounded-full pulse-animation text-indigo-500/20"></div>
                        <div class="w-32 h-32 rounded-full pulse-animation text-indigo-400/30" style="animation-delay: 0.5s"></div>
                    </div>

                    <div class="relative z-10">
                        <div class="flex justify-center mb-4">
                            <span id="roleBadge" class="text-[9px] uppercase tracking-widest font-bold bg-slate-800 text-slate-400 px-3 py-1 rounded-full border border-slate-700">Menunggu...</span>
                        </div>
                        
                        <h2 id="displayRoomId" onclick="copyId()" class="text-5xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-br from-white to-slate-400 tracking-wider mb-2 select-all cursor-pointer hover:opacity-80 transition-opacity" title="Klik Salin">---</h2>
                        
                        <div class="h-6 flex items-center justify-center gap-2">
                             <p id="connectionText" class="text-xs text-slate-500 font-medium tracking-wide">MENGINISIALISASI...</p>
                        </div>
                    </div>
                </div>

                <!-- Info Teknis -->
                <div class="text-[10px] text-slate-500 flex justify-center gap-4 font-mono">
                    <span id="transportInfo"><i class="fa-solid fa-network-wired"></i> PROTOCOL: AUTO</span>
                    <span id="iceInfo"><i class="fa-solid fa-server"></i> RELAY: IDLE</span>
                </div>

                <!-- Kontrol -->
                <div id="controlsArea" class="space-y-3 pt-4">
                    <!-- Mobile Mic Button -->
                    <div id="mobileControls" class="hidden">
                        <button onclick="toggleMic()" id="mobileMicBtn" class="w-full py-6 rounded-xl font-bold text-md flex items-center justify-center gap-3 bg-slate-800 text-slate-500 border border-slate-700 transition-all hover:bg-slate-700">
                            <i class="fa-solid fa-microphone-slash"></i>
                            <span>MIC MUTED</span>
                        </button>
                    </div>

                    <!-- Stop Button -->
                    <button onclick="stopConnection()" class="w-full py-3 rounded-xl border border-red-900/30 text-red-500/70 hover:text-red-400 hover:bg-red-900/10 text-xs transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-power-off"></i> <span>PUTUSKAN KONEKSI</span>
                    </button>
                </div>
            </div>

            <!-- LOGS -->
            <div id="logsWrapper" class="hidden absolute bottom-2 right-2 left-2 z-0">
                <div id="logs" class="text-[9px] font-mono text-slate-600 h-16 overflow-y-auto bg-slate-950/80 p-2 rounded border border-slate-800/50 backdrop-blur pointer-events-none">
                    <div>> System Boot...</div>
                </div>
            </div>

        </main>
    </div>

    <!-- CAMOUFLAGE OVERLAY -->
    <div id="googleOverlay" class="hidden google-overlay">
        <!-- Fake Google Header -->
        <div class="flex justify-end items-center p-4 gap-4 text-[13px] text-gray-600">
            <span class="cursor-pointer hover:underline">Gmail</span>
            <span class="cursor-pointer hover:underline">Images</span>
            <div class="hover:bg-gray-100 p-2 rounded-full cursor-pointer"><i class="fa-solid fa-grip text-gray-500 text-lg"></i></div>
            <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm">J</div>
        </div>
        <!-- Fake Google Body -->
        <div class="flex-1 flex flex-col items-center justify-center -mt-20 px-4">
            <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png" alt="Google" width="272" class="mb-8 opacity-90">
            <div class="w-full max-w-[584px] h-[46px] rounded-full border border-gray-200 flex items-center px-4 gap-3 shadow-sm hover:shadow-md transition-shadow">
                <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                <input type="text" class="flex-1 outline-none text-gray-700" value="">
                <i class="fa-solid fa-microphone text-blue-500"></i>
            </div>
            <div class="mt-8 flex gap-3">
                <button class="g-btn" onclick="toggleCamouflage()">Google Search</button>
                <button class="g-btn">I'm Feeling Lucky</button>
            </div>
        </div>
        <!-- Secret Toggle Area -->
        <button onclick="toggleCamouflage()" class="fixed bottom-0 left-0 w-24 h-24 opacity-0 cursor-default z-50"></button>
    </div>

    <audio id="remoteAudio" autoplay playsinline class="hidden"></audio>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, addDoc, serverTimestamp, deleteDoc, getDocs } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // KONFIGURASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDbhegMTo3-AG4tUPQJkbwlXMbUZmdjVTk",
            authDomain: "p2paudio-fdbde.firebaseapp.com",
            projectId: "p2paudio-fdbde",
            storageBucket: "p2paudio-fdbde.firebasestorage.app",
            messagingSenderId: "734885014321",
            appId: "1:734885014321:web:e6fef64fb7d58802cc9e10"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // VARIABEL UTAMA
        let user = null;
        let peerConnection = null;
        let localStream = null;
        let mode = null;
        let roomId = null;
        let isMuted = true;
        let retryCount = 0;

        // --- KONFIGURASI SERVER STEALTH (KUNCI ANTI BLOKIR) ---
        const servers = {
            iceServers: [
                // 1. Jalur Utama: TURN over TCP Port 443 
                // Ini meniru trafik HTTPS biasa. Provider internet melihat ini sebagai browsing web.
                {
                    urls: "turn:openrelay.metered.ca:443?transport=tcp",
                    username: "openrelayproject",
                    credential: "openrelayproject"
                },
                // 2. Backup: TURN over TCP Port 80
                {
                    urls: "turn:openrelay.metered.ca:80?transport=tcp",
                    username: "openrelayproject",
                    credential: "openrelayproject"
                },
                // 3. Cadangan Terakhir: STUN Google (UDP)
                { urls: "stun:stun.l.google.com:19302" }
            ],
            // Strategi: 'relay' memaksa penggunaan TURN (lebih aman tembus blokir)
            // 'all' lebih cepat tapi bisa gagal jika symmetric NAT.
            // Kita gunakan 'all' tapi urutan server di atas memprioritaskan TCP.
            iceCandidatePoolSize: 10,
        };

        // UI & HELPERS
        function log(msg) {
            const l = document.getElementById('logs');
            l.innerHTML += `<div class="border-b border-white/5 pb-1 mb-1">> ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
            console.log(msg);
        }

        function updateStatus(status, colorClass = 'bg-slate-500', textClass = 'text-slate-400') {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            const box = document.getElementById('connectionStatus');
            
            dot.className = `w-2 h-2 rounded-full ${colorClass}`;
            txt.textContent = status;
            txt.className = textClass;
        }

        // AUTH
        signInAnonymously(auth).catch(e => log("Auth Error: " + e));
        onAuthStateChanged(auth, u => {
            if(u) {
                user = u;
                updateStatus('READY', 'bg-emerald-500', 'text-emerald-400');
            }
        });

        // WEBRTC HANDLERS
        async function setupPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);

            // Audio Handling
            if(localStream) {
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }

            peerConnection.ontrack = (event) => {
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio.srcObject !== event.streams[0]) {
                    remoteAudio.srcObject = event.streams[0];
                    log("Audio Stream Diterima!");
                    document.getElementById('connectionText').textContent = "AUDIO TERHUBUNG";
                }
            };

            // Connection Monitoring
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`State: ${state}`);
                
                if (state === 'connected') {
                    document.getElementById('connectionText').textContent = "TERHUBUNG SECURE (ENCRYPTED)";
                    document.getElementById('connectionText').className = "text-xs text-indigo-400 font-bold tracking-wide animate-pulse";
                    document.getElementById('rippleEffect').classList.remove('hidden');
                    updateStatus('CONNECTED', 'bg-indigo-500', 'text-indigo-400');
                    
                    // Cek tipe koneksi (UDP vs TCP)
                    peerConnection.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                const protocol = report.protocol || 'UNKNOWN';
                                document.getElementById('transportInfo').innerHTML = `<i class="fa-solid fa-network-wired"></i> ${protocol.toUpperCase()}`;
                                if(protocol.toUpperCase() === 'TCP') {
                                    log("Sukses! Menggunakan Tunnel TCP (Stealth Mode)");
                                }
                            }
                        });
                    });

                    // Auto camouflage for host
                    if(mode === 'sender') setTimeout(toggleCamouflage, 2000);
                } 
                else if (state === 'failed' || state === 'disconnected') {
                    updateStatus('RECONNECTING', 'bg-red-500', 'text-red-400');
                    if(retryCount < 3) {
                        log("Koneksi gagal, mencoba restart ICE...");
                        retryCount++;
                        peerConnection.restartIce();
                    }
                }
            };

            peerConnection.onicecandidate = (event) => {
                // Logika: Kita tetap kirim semua kandidat, tapi server TURN TCP ada di urutan awal
                if (event.candidate) {
                    const coll = mode === 'sender' ? 
                        collection(db, `calls/${roomId}/callerCandidates`) : 
                        collection(db, `calls/${roomId}/calleeCandidates`);
                    addDoc(coll, event.candidate.toJSON());
                }
            };
        }

        // --- HOST LOGIC ---
        window.startHosting = async () => {
            if(!user) return alert("Tunggu status READY");
            mode = 'sender';
            roomId = Math.random().toString(36).substring(2, 8).toUpperCase();

            // UI Switch
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('activePage').classList.remove('hidden');
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('roleBadge').textContent = "HOST (LAPTOP)";

            // 1. Bersihkan Data Lama (Penting!)
            const callerRef = collection(db, `calls/${roomId}/callerCandidates`);
            const calleeRef = collection(db, `calls/${roomId}/calleeCandidates`);
            // (Logika delete diabaikan utk efisiensi kode, karena ID random baru)

            // 2. Get Media
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } 
                });
            } catch(e) {
                alert("Gagal akses Mic: " + e.message); return;
            }

            // 3. Setup Connection
            await setupPeerConnection();

            // 4. Create Offer
            const callDoc = doc(db, `calls/${roomId}`);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            await setDoc(callDoc, { 
                offer: { type: offer.type, sdp: offer.sdp },
                createdAt: serverTimestamp()
            });

            // 5. Listen for Answer
            onSnapshot(callDoc, (snapshot) => {
                const data = snapshot.data();
                if (!peerConnection.currentRemoteDescription && data?.answer) {
                    const answer = new RTCSessionDescription(data.answer);
                    peerConnection.setRemoteDescription(answer);
                }
            });

            // 6. Listen for Remote Candidates
            onSnapshot(calleeRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        peerConnection.addIceCandidate(candidate).catch(e => console.log(e));
                    }
                });
            });
        };

        // --- JOIN LOGIC ---
        window.joinRoom = async () => {
            roomId = document.getElementById('joinInput').value.toUpperCase();
            if(!roomId || !user) return;
            mode = 'receiver';

            // UI Switch
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('activePage').classList.remove('hidden');
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('roleBadge').textContent = "MONITOR (HP)";
            document.getElementById('mobileControls').classList.remove('hidden');

            // 1. Get Media (Silent first)
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localStream.getAudioTracks()[0].enabled = false; // Start Muted
                isMuted = true;
            } catch(e) {
                alert("Izinkan Mic untuk mengaktifkan audio dua arah!");
                // Tetap lanjut meski gagal mic, agar bisa mendengar
            }

            // 2. Setup Connection
            await setupPeerConnection();

            // 3. Get Offer & Create Answer
            const callDoc = doc(db, `calls/${roomId}`);
            const callSnapshot = await getDoc(callDoc);
            
            if(!callSnapshot.exists()) {
                alert("ID Tidak Ditemukan!"); window.location.reload(); return;
            }

            const offer = callSnapshot.data().offer;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp } });

            // 4. Listen for ICE
            const callerRef = collection(db, `calls/${roomId}/callerCandidates`);
            onSnapshot(callerRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        peerConnection.addIceCandidate(candidate).catch(e => console.log(e));
                    }
                });
            });
        };

        // CONTROLS
        window.copyId = () => {
            navigator.clipboard.writeText(roomId);
            const el = document.getElementById('displayRoomId');
            const original = el.textContent;
            el.textContent = "COPIED!";
            setTimeout(() => el.textContent = original, 1000);
        };

        window.toggleMic = () => {
            if(!localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            isMuted = !track.enabled;
            
            const btn = document.getElementById('mobileMicBtn');
            if(isMuted) {
                btn.className = "w-full py-6 rounded-xl font-bold text-md flex items-center justify-center gap-3 bg-slate-800 text-slate-500 border border-slate-700 transition-all";
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i><span>MIC MUTED</span>';
            } else {
                btn.className = "w-full py-6 rounded-xl font-bold text-md flex items-center justify-center gap-3 bg-indigo-600 text-white border border-indigo-400 shadow-lg shadow-indigo-500/30 animate-pulse";
                btn.innerHTML = '<i class="fa-solid fa-microphone"></i><span>LIVE AUDIO</span>';
            }
        };

        window.stopConnection = () => window.location.reload();

        window.toggleCamouflage = () => {
            const ol = document.getElementById('googleOverlay');
            const main = document.getElementById('mainAppContainer');
            if(ol.classList.contains('hidden')) {
                ol.classList.remove('hidden');
                main.style.opacity = '0';
                main.style.pointerEvents = 'none';
            } else {
                ol.classList.add('hidden');
                main.style.opacity = '1';
                main.style.pointerEvents = 'auto';
            }
        };
    </script>
</body>
</html>
